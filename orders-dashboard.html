<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders Dashboard - Be Well LifeStyle Centers</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .dashboard-container {
            min-height: 100vh;
            background: var(--bg-color);
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .dashboard-header {
            background: var(--card-bg);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(164, 124, 91, 0.2);
        }
        
        .dashboard-header h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin: 0;
        }
        
        .header-info {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        
        .location-selector {
            background: var(--card-bg);
            border: 2px solid var(--primary-color);
            border-radius: 6px;
            padding: 8px 15px;
            color: var(--text-color);
            font-size: 1.1rem;
            cursor: pointer;
            outline: none;
        }
        
        .refresh-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .refresh-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(164, 124, 91, 0.2);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-color);
            font-size: 1rem;
            opacity: 0.9;
        }

        .orders-table {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(164, 124, 91, 0.2);
            margin-bottom: 30px;
        }
        
        .table-header {
            background: var(--primary-color);
            color: white;
            padding: 20px 30px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .orders-list {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .order-row {
            display: grid;
            grid-template-columns: 180px 130px 120px 120px 1fr 140px;
            padding: 8px 15px;
            border-bottom: 1px solid rgba(164, 124, 91, 0.2);
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .order-row:hover {
            background: rgba(164, 124, 91, 0.05);
            transform: translateX(5px);
        }
        
        .order-details {
            grid-column: 1 / -1;
            background: rgba(164, 124, 91, 0.03);
            padding: 12px;
            margin: 0 -15px;
            border-top: 2px solid rgba(164, 124, 91, 0.2);
            display: none;
        }
        
        .order-details.expanded {
            display: block;
        }
        
        .order-details h4 {
            color: #8B3A7C;
            margin-bottom: 8px;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .items-list {
            margin-bottom: 8px;
        }
        
        .item-detail {
            padding: 3px 0 3px 15px;
            border-bottom: 1px solid rgba(139, 69, 19, 0.1);
        }
        
        .item-detail:last-child {
            border-bottom: none;
        }
        
        .item-name-detail {
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        .item-quantity {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 0.9rem;
            min-width: 80px;
            text-align: right;
        }
        
        .order-vendor {
            font-weight: bold;
            color: #8B3A7C;
            font-size: 1rem;
        }
        
        .order-location {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
            text-align: center;
        }
        
        .location-distribution { background: #e3f2fd; color: #0d47a1; }
        .location-birmingham { background: #f3e5f5; color: #4a148c; }
        .location-uwm { background: #e8f5e8; color: #1b5e20; }
        .location-berkeley { background: #fff3e0; color: #e65100; }
        
        .order-date {
            color: #333;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .order-items {
            color: #333;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .order-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }
        
        .print-btn {
            background: #28a745;
            color: white;
            min-width: 60px;
        }
        
        .print-btn:hover {
            background: #218838;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            min-width: 60px;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: var(--text-color);
            opacity: 0.6;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-section, .print-section * {
                visibility: visible;
            }
            .print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-family: Arial, sans-serif;
                font-size: 12px;
                line-height: 1.2;
                background: white;
                color: black;
            }
            .print-section h2 {
                font-size: 16px;
                margin: 0 0 10px 0;
                color: black;
            }
            .print-section p {
                margin: 3px 0;
                color: black;
            }
            .print-section hr {
                margin: 8px 0;
                border: 1px solid black;
            }
            .print-section div[style*="display: flex"] {
                display: flex !important;
                justify-content: space-between !important;
                margin: 2px 0 !important;
                padding: 0 !important;
            }
            .print-section div[style*="display: flex"] span {
                margin: 0 !important;
                padding: 0 !important;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>📦 Orders Dashboard</h1>
            <div class="header-info">
                <select class="location-selector" id="locationFilter" onchange="filterByLocation()">
                    <option value="all">All Locations</option>
                    <option value="Distribution">Distribution Center</option>
                    <option value="Birmingham">Birmingham</option>
                    <option value="UWM">UWM</option>
                    <option value="Berkeley">Berkeley</option>
                </select>
                <span id="currentTime"></span>
                <span id="currentUser">orders dashboard</span>
                <button class="refresh-btn" onclick="loadOrders()">Refresh</button>
                <button class="refresh-btn" onclick="printFilteredOrders()" style="background: #28a745;">Print All</button>
                <button class="refresh-btn" onclick="removeDuplicates()" style="background: #8b5cf6;">Remove Duplicates</button>
                <button class="refresh-btn" onclick="clearAllOrders()" style="background: #f59e0b;">Clear All</button>
            </div>
        </div>
        
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-number" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingOrders">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="distributionOrders">0</div>
                <div class="stat-label">Distribution</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="locationOrders">0</div>
                <div class="stat-label">Location Orders</div>
            </div>
        </div>

        <div class="orders-table">
            <div class="table-header">
                📋 Vendor Orders
            </div>
            <div class="orders-list" id="ordersList">
                <div class="empty-state">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>No orders yet</h3>
                    <p>Orders will appear here when submitted from the inventory system</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allOrders = [];
        let filteredOrders = [];
        let currentFilter = 'all';
        let expandedOrders = new Set();

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            loadOrders();
            setInterval(loadOrders, 5000); // Auto-refresh every 5 seconds
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }

        function loadOrders() {
            try {
                // Simple localStorage-based orders
                const rawData = localStorage.getItem('allOrders');
                console.log('📋 Raw localStorage data:', rawData);
                allOrders = JSON.parse(rawData || '[]');
                console.log('📋 Dashboard loaded orders:', allOrders.length);
                console.log('📋 Orders data:', allOrders);
                filterByLocation();
                updateStats();
            } catch (error) {
                console.error('Error loading orders:', error);
                allOrders = [];
                filterByLocation();
                updateStats();
            }
        }

        function filterByLocation() {
            const filter = document.getElementById('locationFilter').value;
            currentFilter = filter;
            
            if (filter === 'all') {
                filteredOrders = allOrders;
            } else {
                filteredOrders = allOrders.filter(order => order.location === filter);
            }
            
            renderOrders();
            updateStats();
        }

        function renderOrders() {
            const ordersList = document.getElementById('ordersList');
            console.log('📋 Rendering orders:', filteredOrders.length, 'for filter:', currentFilter);
            
            if (filteredOrders.length === 0) {
                ordersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>No orders for ${currentFilter === 'all' ? 'any location' : currentFilter}</h3>
                        <p>Orders will appear here when submitted from the inventory system</p>
                    </div>
                `;
                return;
            }
            
            ordersList.innerHTML = filteredOrders.map((order, index) => `
                <div class="order-row" onclick="toggleOrderDetails('order-${index}')">
                    <div class="order-vendor">${order.vendor}</div>
                    <div class="order-location location-${order.location.toLowerCase().replace(' ', '-')}">${order.location}</div>
                    <div class="order-date">${new Date(order.timestamp).toLocaleDateString()}</div>
                    <div class="order-date">${new Date(order.timestamp).toLocaleTimeString()}</div>
                    <div class="order-items">${order.itemCount} items (click to expand)</div>
                    <div class="order-actions" onclick="event.stopPropagation()">
                        <button class="action-btn print-btn" onclick="printOrder('${order.id}')">
                            Print
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteOrder('${order.id}')">
                            Delete
                        </button>
                    </div>
                </div>
                <div class="order-details" id="order-${index}">
                    <h4>📋 Order Details - ${order.vendor} for ${order.location}</h4>
                    <div class="items-list">
                        ${order.items && order.items.length > 0 ? order.items.map(item => `
                            <div class="item-detail">
                                <span class="item-name-detail">${item.name || 'Unknown Item'}</span> &nbsp;&nbsp;-&nbsp;&nbsp; <span class="item-quantity"><strong>${item.quantity || '0'} ${item.unit || 'case'}</strong></span>
                            </div>
                        `).join('') : '<p style="color: #999;">No items found</p>'}
                    </div>
                    ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
                    <p><strong>Order Date:</strong> ${order.date || new Date(order.timestamp).toLocaleDateString()}</p>
                    <p style="font-size: 0.8rem; color: #666;"><strong>Debug:</strong> ${order.items ? order.items.length : 0} items, ID: ${order.id}</p>
                </div>
            `).join('');
            
            // Restore expanded states after refresh
            setTimeout(() => {
                expandedOrders.forEach(detailsId => {
                    const details = document.getElementById(detailsId);
                    if (details) {
                        details.classList.add('expanded');
                    }
                });
            }, 10);
        }

        function toggleOrderDetails(detailsId) {
            const details = document.getElementById(detailsId);
            if (details) {
                details.classList.toggle('expanded');
                
                if (details.classList.contains('expanded')) {
                    expandedOrders.add(detailsId);
                } else {
                    expandedOrders.delete(detailsId);
                }
            }
        }

        function updateStats() {
            document.getElementById('totalOrders').textContent = allOrders.length;
            document.getElementById('pendingOrders').textContent = filteredOrders.length;
            document.getElementById('distributionOrders').textContent = allOrders.filter(o => o.location === 'Distribution').length;
            document.getElementById('locationOrders').textContent = allOrders.filter(o => o.location !== 'Distribution').length;
        }

        function deleteOrder(orderId) {
            if (!confirm('Delete this order?')) return;
            
            allOrders = allOrders.filter(order => order.id !== orderId);
            localStorage.setItem('allOrders', JSON.stringify(allOrders));
            filterByLocation();
        }

        function printOrder(orderId) {
            console.log('🖨️ Printing order:', orderId);
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                console.error('Order not found:', orderId);
                alert('Order not found!');
                return;
            }
            
            console.log('🖨️ Found order:', order.vendor, 'for', order.location);
            
            const printContent = `
                <div style="font-family: Arial, sans-serif; padding: 5px; font-size: 14px; line-height: 1.3; background: white; color: black;">
                    <h2 style="margin: 0 0 2px 0; font-size: 18px; color: black;">${order.vendor} - ${order.location.toUpperCase()}</h2>
                    <p style="margin: 0 0 1px 0; color: black; font-size: 12px;">${new Date(order.timestamp).toLocaleDateString()} ${new Date(order.timestamp).toLocaleTimeString()}</p>
                    <hr style="margin: 1px 0; border: 0.5px solid black;">
                    <div style="display: flex; margin: 2px 0; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 1px;">
                        <span style="width: 200px;">Item</span>
                        <span style="padding-left: 12px;">Amount</span>
                    </div>
                    ${order.items.map(item => `
                        <div style="display: flex; margin: 1px 0; padding: 1px 0;">
                            <span style="width: 200px;">${item.name}</span>
                            <span style="padding-left: 12px; font-weight: bold;">${item.quantity} ${item.unit}</span>
                        </div>
                    `).join('')}
                    <hr style="margin: 1px 0; border: 0.5px solid black;">
                    <p style="margin: 0.5px 0; color: black; font-size: 12px;"><strong>Total: ${order.itemCount} items</strong>${order.notes ? ` | Notes: ${order.notes}` : ''}</p>
                </div>
            `;
            
            console.log('🖨️ Opening print window...');
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('Print blocked by popup blocker! Please allow popups for this site.');
                return;
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Order - ${order.vendor} for ${order.location}</title>
                    <style>
                        .print-controls {
                            position: fixed;
                            top: 10px;
                            right: 10px;
                            z-index: 1000;
                            background: white;
                            padding: 10px;
                            border: 2px solid #007bff;
                            border-radius: 5px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        @media print {
                            .print-controls { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-controls">
                        <button onclick="window.print()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 5px;">🖨️ Print</button>
                        <button onclick="window.close()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">✖️ Close</button>
                    </div>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function printFilteredOrders() {
            if (filteredOrders.length === 0) {
                alert('No orders to print for the selected location.');
                return;
            }
            
            // Group orders by vendor and location
            const groupedOrders = {};
            filteredOrders.forEach(order => {
                const key = `${order.vendor}-${order.location}`;
                if (!groupedOrders[key]) {
                    groupedOrders[key] = {
                        vendor: order.vendor,
                        location: order.location,
                        items: {},
                        notes: []
                    };
                }
                
                // Combine quantities for same items
                order.items.forEach(item => {
                    const itemKey = `${item.name}-${item.unit}`;
                    if (groupedOrders[key].items[itemKey]) {
                        groupedOrders[key].items[itemKey].quantity += parseInt(item.quantity);
                    } else {
                        groupedOrders[key].items[itemKey] = {
                            name: item.name,
                            quantity: parseInt(item.quantity),
                            unit: item.unit
                        };
                    }
                });
                
                if (order.notes) {
                    groupedOrders[key].notes.push(order.notes);
                }
            });
            
            const printContent = `
                <div style="font-family: Arial, sans-serif; padding: 5px; font-size: 14px; line-height: 1.3; background: white; color: black;">
                    <h1 style="margin: 0 0 2px 0; font-size: 18px; color: black;">ORDERS SUMMARY - ${currentFilter === 'all' ? 'ALL LOCATIONS' : currentFilter.toUpperCase()}</h1>
                    <p style="margin: 0 0 1px 0; color: black; font-size: 12px;">Generated: ${new Date().toLocaleString()}</p>
                    <hr style="margin: 1px 0; border: 0.5px solid black;">
                    ${Object.values(groupedOrders).map(group => `
                        <div style="margin-bottom: 48px; page-break-inside: avoid;">
                            <h3 style="margin: 1px 0; font-size: 16px; color: black;">${group.vendor} - ${group.location}</h3>
                            <div style="display: flex; margin: 2px 0; font-weight: bold; border-bottom: 1px solid #ccc; padding-bottom: 1px;">
                                <span style="width: 200px;">Item</span>
                                <span style="padding-left: 12px;">Amount</span>
                            </div>
                            ${Object.values(group.items).map(item => `
                                <div style="display: flex; margin: 1px 0; padding: 1px 0;">
                                    <span style="width: 200px;">${item.name}</span>
                                    <span style="padding-left: 12px; font-weight: bold;">${item.quantity} ${item.unit}</span>
                                </div>
                            `).join('')}
                            ${group.notes.length > 0 ? `<p style="margin: 0.5px 0; font-size: 12px; color: #666;">Notes: ${[...new Set(group.notes)].join('; ')}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            
            console.log('🖨️ Opening print window for all orders...');
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('Print blocked by popup blocker! Please allow popups for this site.');
                return;
            }
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Orders Summary - ${currentFilter === 'all' ? 'All Locations' : currentFilter}</title>
                    <style>
                        .print-controls {
                            position: fixed;
                            top: 10px;
                            right: 10px;
                            z-index: 1000;
                            background: white;
                            padding: 10px;
                            border: 2px solid #28a745;
                            border-radius: 5px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        @media print {
                            .print-controls { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-controls">
                        <button onclick="window.print()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 5px;">🖨️ Print All</button>
                        <button onclick="window.close()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">✖️ Close</button>
                    </div>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function removeDuplicates() {
            console.log('🧹 Removing duplicate orders...');
            console.log('📊 Before cleanup:', allOrders.length, 'orders');
            
            // Group orders by vendor + location
            const consolidated = new Map();
            
            allOrders.forEach(order => {
                const key = `${order.vendor}|${order.location}`;
                
                if (consolidated.has(key)) {
                    // Merge items from duplicate order
                    const existing = consolidated.get(key);
                    console.log(`🔀 Merging duplicate ${order.vendor}/${order.location} order`);
                    
                    order.items.forEach(newItem => {
                        const existingItem = existing.items.find(item => 
                            item.name === newItem.name && item.unit === newItem.unit
                        );
                        
                        if (existingItem) {
                            existingItem.quantity += newItem.quantity;
                            console.log(`📊 Combined ${newItem.name}: ${existingItem.quantity} ${newItem.unit}`);
                        } else {
                            existing.items.push(newItem);
                            console.log(`➕ Added ${newItem.name}: ${newItem.quantity} ${newItem.unit}`);
                        }
                    });
                    
                    // Update metadata
                    existing.itemCount = existing.items.length;
                    existing.timestamp = new Date().toISOString();
                    
                    // Merge notes
                    if (order.notes && !existing.notes.includes(order.notes)) {
                        existing.notes = existing.notes ? existing.notes + '\n' + order.notes : order.notes;
                    }
                } else {
                    // First occurrence of this vendor/location
                    consolidated.set(key, { ...order });
                }
            });
            
            // Replace allOrders with consolidated version
            allOrders = Array.from(consolidated.values());
            
            console.log('📊 After cleanup:', allOrders.length, 'orders');
            console.log('✅ Duplicate removal complete');
            
            // Save and refresh
            localStorage.setItem('allOrders', JSON.stringify(allOrders));
            filterByLocation();
            
            alert(`Duplicates removed! ${consolidated.size} unique orders remain.`);
        }

        function clearAllOrders() {
            if (!confirm('Clear all orders? This cannot be undone.')) return;
            
            localStorage.removeItem('allOrders');
            allOrders = [];
            filterByLocation();
        }
    </script>
</body>
</html>