<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Front Desk Dashboard - Be Well UWM</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .dashboard-container {
            min-height: 100vh;
            background: var(--bg-color);
            padding: 20px;
        }
        
        .dashboard-header {
            background: var(--card-bg);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(164, 124, 91, 0.2);
        }
        
        .dashboard-header h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin: 0;
        }
        
        .header-info {
            display: flex;
            gap: 30px;
            align-items: center;
        }
        
        .header-info span {
            color: var(--text-color);
            font-size: 1.1rem;
        }
        
        .refresh-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .refresh-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(164, 124, 91, 0.2);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--text-color);
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .checkins-table {
            background: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(164, 124, 91, 0.2);
        }
        
        .table-header {
            background: rgba(164, 124, 91, 0.1);
            padding: 20px 30px;
            border-bottom: 1px solid rgba(164, 124, 91, 0.2);
        }
        
        .table-header h2 {
            color: var(--primary-color);
            margin: 0;
            font-size: 1.5rem;
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: rgba(164, 124, 91, 0.05);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid rgba(164, 124, 91, 0.2);
        }
        
        td {
            padding: 15px;
            color: var(--text-color);
            border-bottom: 1px solid rgba(164, 124, 91, 0.1);
        }
        
        tr:hover {
            background: rgba(164, 124, 91, 0.05);
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-waiting {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .status-active {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .status-completed {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }
        
        .action-btns {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
        }
        
        .btn-checkin {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-checkin:hover {
            background: var(--secondary-color);
        }
        
        .btn-checkout {
            background: #6b7280;
            color: white;
        }
        
        .btn-checkout:hover {
            background: #4b5563;
        }
        
        .btn-comment {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        
        .btn-comment:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .comment-input {
            width: 100%;
            padding: 8px;
            border: 1px solid rgba(164, 124, 91, 0.3);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        .wait-time {
            font-size: 0.9rem;
            color: #9ca3af;
        }
        
        .first-visit-yes {
            color: #22c55e;
            font-weight: 600;
        }
        
        .first-visit-no {
            color: #6b7280;
        }
        
        /* Modal for comments */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background: var(--card-bg);
            margin: 15% auto;
            padding: 30px;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            border: 1px solid rgba(164, 124, 91, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: var(--primary-color);
            margin: 0;
        }
        
        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
        }
        
        .close-modal:hover {
            opacity: 1;
        }
        
        /* Edit mode styles */
        .editable-cell {
            cursor: pointer;
            position: relative;
            transition: background 0.2s ease;
        }
        
        .editable-cell:hover {
            background: rgba(164, 124, 91, 0.15);
            border-radius: 4px;
        }
        
        .editable-cell:hover::after {
            content: "✏️";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .edit-input {
            width: 100%;
            padding: 6px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 0.9rem;
        }
        
        .edit-select {
            width: 100%;
            padding: 6px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 0.9rem;
        }
        
        .edit-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        
        .edit-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .edit-save {
            background: #22c55e;
            color: white;
        }
        
        .edit-cancel {
            background: #6b7280;
            color: white;
        }
        
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid rgba(164, 124, 91, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-color);
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .btn-save {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-save:hover {
            background: var(--secondary-color);
        }
        
        .btn-cancel {
            background: transparent;
            color: var(--text-color);
            border: 1px solid rgba(164, 124, 91, 0.3);
        }
        
        .btn-cancel:hover {
            background: rgba(164, 124, 91, 0.1);
        }
        
        @media (max-width: 1200px) {
            .table-wrapper {
                overflow-x: scroll;
            }
            
            table {
                min-width: 1000px;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 20px;
            }
            
            .header-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>Front Desk Dashboard - UWM</h1>
            <p style="color: #2196F3; font-size: 0.9rem; margin-top: -10px;">University Walk Medical Location</p>
            <div class="header-info">
                <span id="currentTime"></span>
                <span id="currentUser">front desk uwm</span>
                <span id="refreshStatus" style="color: #22c55e; font-size: 0.9rem;">●</span>
                <button class="refresh-btn" onclick="loadCheckins()">Refresh</button>
                <!-- Debug button hidden for production -->
                <!-- <button class="refresh-btn" onclick="testLocalStorage()" style="background: #ef4444;">Debug</button> -->
                <button class="refresh-btn" onclick="addClientManually()" style="background: #22c55e;">Add Client</button>
                <button class="refresh-btn" onclick="clearAllData()" style="background: #f59e0b;">End of Day</button>
            </div>
        </div>
        
        
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-number" id="waitingCount">0</div>
                <div class="stat-label">Waiting</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeCount">0</div>
                <div class="stat-label">Being Seen</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedCount">0</div>
                <div class="stat-label">Completed Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgWaitTime">0</div>
                <div class="stat-label">Avg Wait (min)</div>
            </div>
        </div>
        
        <div class="checkins-table">
            <div class="table-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <h2>Today's Check-Ins</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="statusFilter" onchange="filterByStatus()" style="padding: 8px 15px; border: 2px solid var(--primary-color); border-radius: 6px; background: var(--card-bg); color: var(--text-color); font-size: 1rem;">
                        <option value="checked-in">Not Checked In</option>
                        <option value="in-treatment">Currently in Treatment</option>
                        <option value="was-seen">Was Seen</option>
                        <option value="all-today">All Patients Seen Today (Ready for Print)</option>
                    </select>
                    <button class="refresh-btn" onclick="openAddPatientModal()" style="background: #22c55e;">
                        + Add Patient
                    </button>
                </div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Time In</th>
                            <th>1st Visit</th>
                            <th>Reason</th>
                            <th>Sub-Reason</th>
                            <th>Wait Time</th>
                            <th>Status</th>
                            <th>Ack By</th>
                            <th>Comment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="checkinsTableBody">
                        <!-- Data populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Comment Modal -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Comment</h3>
                <span class="close-modal" onclick="closeCommentModal()">&times;</span>
            </div>
            <textarea id="commentText" placeholder="Enter your comment here..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" onclick="closeCommentModal()">Cancel</button>
                <button class="modal-btn btn-save" onclick="saveComment()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Add Patient Modal -->
    <div id="addPatientModal" class="modal">
        <div class="modal-content" style="width: 600px;">
            <div class="modal-header">
                <h3>Add Patient Check-In</h3>
                <span class="close-modal" onclick="closeAddPatientModal()">&times;</span>
            </div>
            <form id="addPatientForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary-color);">Patient Name *</label>
                        <input type="text" id="addPatientName" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary-color);">Phone Number *</label>
                        <input type="tel" id="addPatientPhone" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;" placeholder="(248) 555-0123" oninput="formatPhoneNumber(this)">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary-color);">First Visit?</label>
                        <select id="addPatientFirstVisit" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
                            <option value="NO">NO - Returning Patient</option>
                            <option value="YES">YES - First Time</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary-color);">Check-In Time</label>
                        <input type="time" id="addPatientTime" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary-color);">Service Requested</label>
                        <select id="addPatientReason" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
                            <option value="Chiropractic">Chiropractic</option>
                            <option value="Massage">Massage</option>
                            <option value="Dry Needling">Dry Needling</option>
                            <option value="Cupping">Cupping</option>
                            <option value="IV Therapy">IV Therapy</option>
                            <option value="Vitamin Injections">Vitamin Injections</option>
                            <option value="Blood Labs">Blood Labs</option>
                            <option value="Consultations">Consultations</option>
                            <option value="Colon Hydrotherapy">Colon Hydrotherapy</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary-color);">Sub-Service (Optional)</label>
                        <select id="addPatientSubReason" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
                            <option value="">Select sub-service...</option>
                            <option value="Chiropractic">Chiropractic</option>
                            <option value="Massage">Massage</option>
                            <option value="Dry Needling">Dry Needling</option>
                            <option value="Cupping">Cupping</option>
                            <option value="IV Therapy">IV Therapy</option>
                            <option value="Vitamin Injections">Vitamin Injections</option>
                            <option value="Blood Labs">Blood Labs</option>
                            <option value="Consultations">Consultations</option>
                            <option value="Colon Hydrotherapy">Colon Hydrotherapy</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary-color);">Notes (Optional)</label>
                    <textarea id="addPatientComment" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; min-height: 60px;" placeholder="Any special notes or instructions..."></textarea>
                </div>
            </form>
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" onclick="closeAddPatientModal()">Cancel</button>
                <button class="modal-btn btn-save" onclick="addPatientCheckin()">Add Patient</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentCommentId = null;
        
        // Update current time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Calculate wait time
        function calculateWaitTime(timeIn) {
            const checkinTime = new Date(`${new Date().toDateString()} ${timeIn}`);
            const now = new Date();
            const diffMs = now - checkinTime;
            const diffMins = Math.floor(diffMs / 60000);
            return diffMins;
        }
        
        // Format wait time display
        function formatWaitTime(minutes) {
            if (minutes < 60) {
                return `${minutes} min`;
            } else {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours}h ${mins}m`;
            }
        }
        
        // Load and display check-ins
        function loadCheckins() {
            fetch('/.netlify/functions/checkin-sync-uwm')
                .then(r => r.json())
                .then(serverData => {
                    let local = JSON.parse(localStorage.getItem('allCheckins')||'[]');
                    if (serverData.success && serverData.checkins) {
                        serverData.checkins.forEach(item => {
                            if (!local.find(c=>c.id===item.id)) {
                                local.push(item);
                                console.log('Added server checkin:', item.name);
                            }
                        });
                        localStorage.setItem('allCheckins', JSON.stringify(local));
                    }
                    processCheckins(local);
                })
                .catch((error) => {
                    console.warn('Server fetch failed, using localStorage only:', error);
                    // fallback
                    processCheckins(JSON.parse(localStorage.getItem('allCheckins')||'[]'));
                });
        }
        
        // Process checkins data (extracted from loadCheckins)
        function processCheckins(checkins) {
            try {
                // Show refresh indicator
                const refreshStatus = document.getElementById('refreshStatus');
                refreshStatus.style.color = '#f59e0b';
                refreshStatus.textContent = '⟳';
                const today = new Date().toISOString().split('T')[0];
                
                // SAFETY: Only show today's check-ins by default (prevents day-to-day accumulation)
                const todayCheckins = checkins.filter(c => c.dateIn === today);
                
                // CHECK: If End of Day was already run today, hide completed patients
                const lastArchiveDate = localStorage.getItem('lastArchiveDate');
                const displayCheckins = (lastArchiveDate === today) 
                    ? todayCheckins.filter(c => c.status !== 'completed')
                    : todayCheckins;
                
                console.log('📅 Dashboard filter - Today:', today);
                console.log('📅 Dashboard filter - Total checkins in system:', checkins.length);
                console.log('📅 Dashboard filter - Today checkins shown:', displayCheckins.length);
                console.log('📅 Dashboard filter - Completed hidden:', lastArchiveDate === today);
                
                const tbody = document.getElementById('checkinsTableBody');
                tbody.innerHTML = '';
            
            // Show message if no check-ins
            if (displayCheckins.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="11" style="text-align: center; padding: 40px; color: #9ca3af; font-style: italic;">
                        ${checkins.length === 0 ? 'No check-ins recorded yet today' : 'No check-ins for today\'s date (' + today + ')'}
                        <br><small>Total check-ins in system: ${checkins.length}</small>
                    </td>
                `;
                tbody.appendChild(row);
            }
            
            // Stats
            let waitingCount = 0;
            let activeCount = 0;
            let completedCount = 0;
            let totalWaitTime = 0;
            let waitingPatients = 0;
            
            displayCheckins.forEach(checkin => {
                const waitTime = checkin.status === 'waiting' ? calculateWaitTime(checkin.timeIn) : 
                                checkin.ackTime ? calculateWaitTime(checkin.timeIn) : 0;
                
                if (checkin.status === 'waiting') {
                    waitingCount++;
                    totalWaitTime += waitTime;
                    waitingPatients++;
                } else if (checkin.status === 'active') {
                    activeCount++;
                } else if (checkin.status === 'completed') {
                    completedCount++;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'name', this)"><strong>${checkin.name}</strong></td>
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'phone', this)">${checkin.phone}</td>
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'timeIn', this)">${checkin.timeIn}</td>
                    <td class="editable-cell ${checkin.firstVisit === 'YES' ? 'first-visit-yes' : 'first-visit-no'}" onclick="editField('${checkin.id}', 'firstVisit', this)">${checkin.firstVisit}</td>
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'reason', this)">${checkin.reason}</td>
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'subReason', this)">${checkin.subReason || '-'}</td>
                    <td class="wait-time">${checkin.status === 'waiting' ? formatWaitTime(waitTime) : '-'}</td>
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'status', this)"><span class="status-badge status-${checkin.status}">${checkin.status}</span></td>
                    <td>${checkin.ackBy || '-'}</td>
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'comment', this)">${checkin.comment || ''}</td>
                    <td>
                        <div class="action-btns">
                            ${checkin.status === 'waiting' ? 
                                `<button class="action-btn btn-checkin" onclick="acknowledgePatient('${checkin.id}')">Check In</button>` :
                                checkin.status === 'active' ?
                                `<button class="action-btn btn-checkout" onclick="checkoutPatient('${checkin.id}')">Check Out</button>` :
                                ''
                            }
                            <button class="action-btn btn-comment" onclick="openCommentModal('${checkin.id}')">Comment</button>
                            <button class="action-btn" onclick="deletePatient('${checkin.id}')" style="background: #ef4444; color: white;">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update stats
            document.getElementById('waitingCount').textContent = waitingCount;
            document.getElementById('activeCount').textContent = activeCount;
            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('avgWaitTime').textContent = waitingPatients > 0 ? 
                Math.round(totalWaitTime / waitingPatients) : 0;
            
                // Show refresh complete
                refreshStatus.style.color = '#22c55e';
                refreshStatus.textContent = '●';
                
                console.log('Refresh complete - displayed', displayCheckins.length, 'check-ins');
                
            } catch (e) {
                console.error('Error processing checkins:', e);
                alert('Error processing check-ins: ' + e.message);
            }
        }
        
        // Acknowledge patient (check them in)
        function acknowledgePatient(id) {
            const checkins = JSON.parse(localStorage.getItem('allCheckins') || '[]');
            const checkinIndex = checkins.findIndex(c => c.id === id);
            
            if (checkinIndex !== -1) {
                checkins[checkinIndex].status = 'active';
                checkins[checkinIndex].ackTime = new Date().toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                checkins[checkinIndex].ackBy = document.getElementById('currentUser').textContent;
                
                localStorage.setItem('allCheckins', JSON.stringify(checkins));
                loadCheckins();
            }
        }
        
        // Delete patient entry
        function deletePatient(id) {
            const checkins = JSON.parse(localStorage.getItem('allCheckins') || '[]');
            const checkin = checkins.find(c => c.id === id);
            
            if (!checkin) {
                alert('Patient not found.');
                return;
            }
            
            const confirmDelete = confirm(`Are you sure you want to delete ${checkin.name}?\n\nThis action cannot be undone.`);
            
            if (confirmDelete) {
                const updatedCheckins = checkins.filter(c => c.id !== id);
                localStorage.setItem('allCheckins', JSON.stringify(updatedCheckins));
                
                // Also notify server
                try {
                    fetch('/.netlify/functions/checkin-sync-uwm', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'delete', id: id, deletedBy: document.getElementById('currentUser').textContent })
                    });
                } catch (e) {
                    console.log('Server delete notification failed (not critical):', e);
                }
                
                console.log('Deleted patient:', checkin.name, 'ID:', id);
                console.log('Remaining checkins:', updatedCheckins.length);
                
                loadCheckins();
                alert(`${checkin.name} has been removed from the system.`);
            }
        }

        // Check out patient
        function checkoutPatient(id) {
            const checkins = JSON.parse(localStorage.getItem('allCheckins') || '[]');
            const checkinIndex = checkins.findIndex(c => c.id === id);
            
            if (checkinIndex !== -1) {
                checkins[checkinIndex].status = 'completed';
                checkins[checkinIndex].outTime = new Date().toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                checkins[checkinIndex].outBy = document.getElementById('currentUser').textContent;
                
                localStorage.setItem('allCheckins', JSON.stringify(checkins));
                loadCheckins();
            }
        }
        
        // Comment modal functions
        function openCommentModal(id) {
            currentCommentId = id;
            document.getElementById('commentModal').style.display = 'block';
            
            // Load existing comment
            const checkins = JSON.parse(localStorage.getItem('allCheckins') || '[]');
            const checkin = checkins.find(c => c.id === id);
            if (checkin && checkin.comment) {
                document.getElementById('commentText').value = checkin.comment;
            } else {
                document.getElementById('commentText').value = '';
            }
        }
        
        function closeCommentModal() {
            document.getElementById('commentModal').style.display = 'none';
            currentCommentId = null;
        }
        
        function saveComment() {
            if (!currentCommentId) return;
            
            const checkins = JSON.parse(localStorage.getItem('allCheckins') || '[]');
            const checkinIndex = checkins.findIndex(c => c.id === currentCommentId);
            
            if (checkinIndex !== -1) {
                checkins[checkinIndex].comment = document.getElementById('commentText').value;
                localStorage.setItem('allCheckins', JSON.stringify(checkins));
                loadCheckins();
                closeCommentModal();
            }
        }
        
        // Refresh dashboard
        function refreshDashboard() {
            loadCheckins();
        }
        
        // Test localStorage contents
        function testLocalStorage() {
            try {
                const allCheckinsData = localStorage.getItem('allCheckins');
                const patientCheckinsData = localStorage.getItem('patientCheckins');
                const today = new Date().toISOString().split('T')[0];
                
                let debugInfo = `COMPLETE DEBUG INFO:\n`;
                debugInfo += `Today: ${today}\n`;
                debugInfo += `URL: ${window.location.href}\n\n`;
                
                debugInfo += `allCheckins key: ${allCheckinsData ? 'HAS DATA' : 'EMPTY'}\n`;
                if (allCheckinsData) {
                    const parsed = JSON.parse(allCheckinsData);
                    debugInfo += `  Items: ${parsed.length}\n`;
                    parsed.forEach((item, index) => {
                        debugInfo += `  ${index + 1}. ${item.name} (${item.dateIn})\n`;
                    });
                }
                
                debugInfo += `\npatientCheckins key: ${patientCheckinsData ? 'HAS DATA' : 'EMPTY'}\n`;
                if (patientCheckinsData) {
                    const parsed = JSON.parse(patientCheckinsData);
                    debugInfo += `  Items: ${parsed.length}\n`;
                }
                
                alert(debugInfo);
            } catch (e) {
                alert('Debug error: ' + e.message);
            }
        }
        
        // Add test check-in for debugging
        function addClientManually() {
            // Prompt for client information
            const name = prompt('Enter client name (First and Last):');
            if (!name || name.trim() === '') return;
            
            const phone = prompt('Enter phone number:');
            if (!phone || phone.trim() === '') return;
            
            const firstVisit = confirm('Is this their first visit?') ? 'YES' : 'NO';
            
            const reason = prompt('Service needed (Chiropractic, Massage, Dry Needling, Cupping, IV Therapy, Vitamin Injections, Blood Labs, Consultations, Colon Hydrotherapy, Other):', 'Chiropractic');
            if (!reason || reason.trim() === '') return;
            
            const comment = prompt('Any additional notes (optional):') || '';
            
            const manualCheckin = {
                name: name.trim(),
                phone: phone.trim(),
                firstVisit: firstVisit,
                reason: reason.trim(),
                subReason: '',
                dateIn: new Date().toISOString().split('T')[0],
                timeIn: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                source: 'Manual Entry',
                ackTime: '',
                ackBy: '',
                outTime: '',
                outBy: '',
                comment: comment.trim(),
                status: 'waiting',
                id: Date.now().toString(),
                timestamp: new Date().toISOString()
            };
            
            let checkins = JSON.parse(localStorage.getItem('allCheckins') || '[]');
            checkins.push(manualCheckin);
            localStorage.setItem('allCheckins', JSON.stringify(checkins));
            
            console.log('Manual checkin added:', manualCheckin);
            console.log('Total checkins now:', checkins.length);
            alert('Client added successfully! ' + name + ' is now in the system.');
            loadCheckins();
        }
        
        // Edit field functionality
        function editField(checkInId, fieldName, cellElement) {
            // Prevent editing if already in edit mode
            if (cellElement.querySelector('.edit-input') || cellElement.querySelector('.edit-select')) {
                return;
            }
            
            const checkins = JSON.parse(localStorage.getItem('allCheckins') || '[]');
            const checkin = checkins.find(c => c.id === checkInId);
            
            if (!checkin) return;
            
            const currentValue = checkin[fieldName] || '';
            const originalHTML = cellElement.innerHTML;
            
            let inputHTML = '';
            
            // Create appropriate input based on field type
            if (fieldName === 'firstVisit') {
                inputHTML = `
                    <select class="edit-select" id="edit-${checkInId}-${fieldName}">
                        <option value="YES" ${currentValue === 'YES' ? 'selected' : ''}>YES</option>
                        <option value="NO" ${currentValue === 'NO' ? 'selected' : ''}>NO</option>
                    </select>
                `;
            } else if (fieldName === 'status') {
                inputHTML = `
                    <select class="edit-select" id="edit-${checkInId}-${fieldName}">
                        <option value="waiting" ${currentValue === 'waiting' ? 'selected' : ''}>waiting</option>
                        <option value="active" ${currentValue === 'active' ? 'selected' : ''}>active</option>
                        <option value="completed" ${currentValue === 'completed' ? 'selected' : ''}>completed</option>
                    </select>
                `;
            } else if (fieldName === 'reason') {
                inputHTML = `
                    <select class="edit-select" id="edit-${checkInId}-${fieldName}">
                        <option value="Chiropractic" ${currentValue === 'Chiropractic' ? 'selected' : ''}>Chiropractic</option>
                        <option value="Massage" ${currentValue === 'Massage' ? 'selected' : ''}>Massage</option>
                        <option value="Dry Needling" ${currentValue === 'Dry Needling' ? 'selected' : ''}>Dry Needling</option>
                        <option value="Cupping" ${currentValue === 'Cupping' ? 'selected' : ''}>Cupping</option>
                        <option value="IV Therapy" ${currentValue === 'IV Therapy' ? 'selected' : ''}>IV Therapy</option>
                        <option value="Vitamin Injections" ${currentValue === 'Vitamin Injections' ? 'selected' : ''}>Vitamin Injections</option>
                        <option value="Blood Labs" ${currentValue === 'Blood Labs' ? 'selected' : ''}>Blood Labs</option>
                        <option value="Consultations" ${currentValue === 'Consultations' ? 'selected' : ''}>Consultations</option>
                        <option value="Colon Hydrotherapy" ${currentValue === 'Colon Hydrotherapy' ? 'selected' : ''}>Colon Hydrotherapy</option>
                        <option value="Other" ${currentValue === 'Other' ? 'selected' : ''}>Other</option>
                    </select>
                `;
            } else if (fieldName === 'timeIn') {
                inputHTML = `<input type="time" class="edit-input" id="edit-${checkInId}-${fieldName}" value="${currentValue}">`;
            } else {
                inputHTML = `<input type="text" class="edit-input" id="edit-${checkInId}-${fieldName}" value="${currentValue}">`;
            }
            
            inputHTML += `
                <div class="edit-controls">
                    <button class="edit-btn edit-save" onclick="saveFieldEdit('${checkInId}', '${fieldName}', this)">Save</button>
                    <button class="edit-btn edit-cancel" onclick="cancelFieldEdit(this, '${originalHTML.replace(/'/g, '&#39;')}')">Cancel</button>
                </div>
            `;
            
            cellElement.innerHTML = inputHTML;
            cellElement.querySelector('.edit-input, .edit-select').focus();
        }
        
        function saveFieldEdit(checkInId, fieldName, buttonElement) {
            const cellElement = buttonElement.closest('td');
            const inputElement = cellElement.querySelector('.edit-input, .edit-select');
            const newValue = inputElement.value;
            
            // Update the data
            const checkins = JSON.parse(localStorage.getItem('allCheckins') || '[]');
            const checkinIndex = checkins.findIndex(c => c.id === checkInId);
            
            if (checkinIndex !== -1) {
                checkins[checkinIndex][fieldName] = newValue;
                localStorage.setItem('allCheckins', JSON.stringify(checkins));
                
                // Refresh the table to show updated data
                loadCheckins();
                
                console.log(`Updated ${fieldName} for ${checkInId} to: ${newValue}`);
            }
        }
        
        function cancelFieldEdit(buttonElement, originalHTML) {
            const cellElement = buttonElement.closest('td');
            cellElement.innerHTML = originalHTML;
        }

        // Phone number formatting function
        function formatPhoneNumber(input) {
            // Remove all non-digit characters
            let value = input.value.replace(/\D/g, '');
            
            // Apply formatting
            if (value.length >= 6) {
                value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
            } else if (value.length >= 3) {
                value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
            }
            
            input.value = value;
        }

        // Add Patient Modal Functions
        function openAddPatientModal() {
            document.getElementById('addPatientModal').style.display = 'block';
            // Set current time as default
            const now = new Date();
            document.getElementById('addPatientTime').value = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }
        
        function closeAddPatientModal() {
            document.getElementById('addPatientModal').style.display = 'none';
            // Clear form
            document.getElementById('addPatientForm').reset();
        }
        
        function addPatientCheckin() {
            // Get form values
            const name = document.getElementById('addPatientName').value.trim();
            const phone = document.getElementById('addPatientPhone').value.trim();
            const firstVisit = document.getElementById('addPatientFirstVisit').value;
            const time = document.getElementById('addPatientTime').value;
            const reason = document.getElementById('addPatientReason').value;
            const subReason = document.getElementById('addPatientSubReason').value.trim();
            const comment = document.getElementById('addPatientComment').value.trim();
            
            // Validate required fields
            if (!name) {
                alert('Patient name is required');
                return;
            }
            if (!phone) {
                alert('Phone number is required');
                return;
            }
            
            const patientCheckin = {
                name: name,
                phone: phone,
                firstVisit: firstVisit,
                reason: reason,
                subReason: subReason || '',
                dateIn: new Date().toISOString().split('T')[0],
                timeIn: time || new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                source: 'Front Desk Manual Entry',
                ackTime: '',
                ackBy: '',
                outTime: '',
                outBy: '',
                comment: comment,
                status: 'waiting',
                id: Date.now().toString(),
                timestamp: new Date().toISOString()
            };
            
            let checkins = JSON.parse(localStorage.getItem('allCheckins') || '[]');
            checkins.push(patientCheckin);
            localStorage.setItem('allCheckins', JSON.stringify(checkins));
            
            console.log('Patient checkin added:', patientCheckin);
            console.log('Total checkins now:', checkins.length);
            
            closeAddPatientModal();
            loadCheckins();
            alert('Patient added successfully! ' + name + ' is now in the system.');
        }

        // Archive all check-ins and generate report
        function clearAllData() {
            console.log('🗃️ Starting End of Day process...');
            
            const checkins = JSON.parse(localStorage.getItem('allCheckins') || '[]');
            const today = new Date().toISOString().split('T')[0];
            const todayCheckins = checkins.filter(c => c.dateIn === today);
            
            console.log('📊 Debug - Total checkins:', checkins.length);
            console.log('📊 Debug - Today checkins:', todayCheckins.length);
            console.log('📊 Debug - Today date:', today);
            
            if (todayCheckins.length === 0) {
                alert('No check-ins to archive today.');
                return;
            }
            
            // Archive ALL today's check-ins (not just completed)
            const archiveKey = `archive_${today}`;
            const archivedData = {
                date: today,
                checkins: todayCheckins,
                archivedAt: new Date().toISOString(),
                stats: {
                    total: todayCheckins.length,
                    completed: todayCheckins.filter(c => c.status === 'completed').length,
                    active: todayCheckins.filter(c => c.status === 'active').length,
                    waiting: todayCheckins.filter(c => c.status === 'waiting').length
                }
            };
            
            localStorage.setItem(archiveKey, JSON.stringify(archivedData));
            console.log('💾 Debug - Archived to key:', archiveKey);
            
            // Mark that End of Day was run today
            localStorage.setItem('lastArchiveDate', today);
            localStorage.setItem('endOfDayProcessed', today);
            
            // DON'T remove today's patients - keep them visible until tomorrow
            // The system will auto-clean old dates on the next day
            console.log('🔄 Debug - Total checkins:', checkins.length);
            console.log('🔄 Debug - Today checkins archived:', todayCheckins.length);
            console.log('📋 Debug - Patients remain visible until tomorrow');
            
            // Also send to server for sync
            try {
                fetch('/.netlify/functions/checkin-sync-uwm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'archive', date: today, archived: todayCheckins })
                });
            } catch (e) {
                console.log('Server archive notification failed (not critical):', e);
            }
            
            // Generate printable report
            generateDailyReport(todayCheckins, today);
            
            alert(`End of Day complete! Archived ${todayCheckins.length} check-ins. Print report now. All patients remain visible until tomorrow.`);
        }
        
        // Generate printable daily report
        function generateDailyReport(checkins, date) {
            const reportWindow = window.open('', '_blank');
            const stats = {
                total: checkins.length,
                firstTime: checkins.filter(c => c.firstVisit === 'YES').length,
                returning: checkins.filter(c => c.firstVisit === 'NO').length
            };
            
            const serviceBreakdown = {};
            checkins.forEach(c => {
                serviceBreakdown[c.reason] = (serviceBreakdown[c.reason] || 0) + 1;
            });
            
            const reportHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Daily Report - ${date}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #A47C5B; padding-bottom: 20px; }
                        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
                        .stat-box { text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px; }
                        .stat-number { font-size: 2rem; font-weight: bold; color: #A47C5B; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #A47C5B; color: white; }
                        .services { margin-bottom: 30px; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Be Well Lifestyle Centers</h1>
                        <h2>Daily Check-In Report</h2>
                        <p><strong>Date:</strong> ${new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-box">
                            <div class="stat-number">${stats.total}</div>
                            <div>Total Patients</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${stats.firstTime}</div>
                            <div>First Time Visitors</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number">${stats.returning}</div>
                            <div>Returning Patients</div>
                        </div>
                    </div>
                    
                    <div class="services">
                        <h3>Services Provided</h3>
                        ${Object.entries(serviceBreakdown).map(([service, count]) => 
                            `<p><strong>${service}:</strong> ${count} patient${count !== 1 ? 's' : ''}</p>`
                        ).join('')}
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Time In</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Service</th>
                                <th>First Visit</th>
                                <th>Check Out Time</th>
                                <th>Staff</th>
                                <th>Comments</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${checkins.map(c => `
                                <tr>
                                    <td>${c.timeIn}</td>
                                    <td>${c.name}</td>
                                    <td>${c.phone}</td>
                                    <td>${c.reason}</td>
                                    <td>${c.firstVisit}</td>
                                    <td>${c.outTime || '-'}</td>
                                    <td>${c.outBy || '-'}</td>
                                    <td>${c.comment || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <button onclick="window.print()" style="padding: 15px 30px; font-size: 1.2rem; background: #A47C5B; color: white; border: none; border-radius: 8px; cursor: pointer;">Print Report</button>
                </body>
                </html>
            `;
            
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const commentModal = document.getElementById('commentModal');
            const addPatientModal = document.getElementById('addPatientModal');
            
            if (event.target === commentModal) {
                closeCommentModal();
            }
            if (event.target === addPatientModal) {
                closeAddPatientModal();
            }
        }
        
        // Listen for messages from check-in page
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'NEW_CHECKIN') {
                console.log('Received new check-in from kiosk:', event.data.data);
                
                // Add to our localStorage
                let checkins = JSON.parse(localStorage.getItem('allCheckins') || '[]');
                checkins.push(event.data.data);
                localStorage.setItem('allCheckins', JSON.stringify(checkins));
                
                // Refresh dashboard immediately
                loadCheckins();
                
                alert('New check-in received: ' + event.data.data.name);
            }
            
            // Also listen for CHECKIN_SAVED messages
            if (event.data && event.data.type === 'CHECKIN_SAVED') {
                console.log('Received CHECKIN_SAVED from kiosk:', event.data.data);
                
                let all = JSON.parse(localStorage.getItem('allCheckins') || '[]');
                
                // Check if we already have this record
                if (!all.find(c => c.id === event.data.data.id)) {
                    all.push(event.data.data);
                    localStorage.setItem('allCheckins', JSON.stringify(all));
                    loadCheckins();
                    console.log('Added new checkin from message:', event.data.data.name);
                }
            }
        });
        
        // Also check for individual checkins every few seconds
        function checkForNewCheckins() {
            const keys = Object.keys(localStorage);
            const checkinKeys = keys.filter(key => key.startsWith('lastCheckin_'));
            
            if (checkinKeys.length > 0) {
                // Found individual checkins, add them to main list
                let checkins = JSON.parse(localStorage.getItem('patientCheckins') || '[]');
                let newCheckins = 0;
                
                checkinKeys.forEach(key => {
                    const checkinData = JSON.parse(localStorage.getItem(key));
                    
                    // Check if we already have this checkin
                    if (!checkins.find(c => c.id === checkinData.id)) {
                        checkins.push(checkinData);
                        newCheckins++;
                    }
                    
                    // Remove the individual key
                    localStorage.removeItem(key);
                });
                
                if (newCheckins > 0) {
                    localStorage.setItem('patientCheckins', JSON.stringify(checkins));
                    loadCheckins();
                    console.log('Found and added', newCheckins, 'new checkins');
                }
            }
        }
        
        // Import individual checkins from kiosk
        function importIndividualCheckins() {
            // scan for keys like "checkin_1234567890"
            let imported = 0;
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('checkin_')) {
                    try {
                        const rec = JSON.parse(localStorage.getItem(key));
                        let all = JSON.parse(localStorage.getItem('allCheckins') || '[]');
                        
                        // Check if we already have this record
                        if (!all.find(c => c.id === rec.id)) {
                            all.push(rec);
                            localStorage.setItem('allCheckins', JSON.stringify(all));
                            imported++;
                            console.log('Imported checkin:', rec.name, 'from key:', key);
                        }
                    } catch(e) {
                        console.warn('Couldn\'t import', key, e);
                    }
                    localStorage.removeItem(key);
                }
            });
            
            if (imported > 0) {
                console.log('Imported', imported, 'new checkins from individual keys');
            }
        }

        // Filter checkins by status
        function filterByStatus() {
            // Simply reload with the new filter
            loadCheckins();
        }
        
        // Display archived checkins (read-only)
        function displayArchivedCheckins(checkins) {
            const tbody = document.getElementById('checkinsTableBody');
            tbody.innerHTML = '';
            
            if (checkins.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px;">No archived check-ins found.</td></tr>';
                return;
            }
            
            checkins.forEach(checkin => {
                const row = document.createElement('tr');
                row.style.opacity = '0.7';
                row.innerHTML = `
                    <td><strong>${checkin.name}</strong></td>
                    <td>${checkin.phone}</td>
                    <td>${checkin.timeIn}</td>
                    <td class="${checkin.firstVisit === 'YES' ? 'first-visit-yes' : 'first-visit-no'}">${checkin.firstVisit}</td>
                    <td>${checkin.reason}</td>
                    <td>${checkin.subReason || '-'}</td>
                    <td>-</td>
                    <td><span class="status-badge status-${checkin.status}">${checkin.status}</span></td>
                    <td>${checkin.ackBy || '-'}</td>
                    <td>${checkin.comment || ''}</td>
                    <td><span style="color: #999;">Archived</span></td>
                `;
                tbody.appendChild(row);
            });
            
            // Update stats for archived view
            document.getElementById('waitingCount').textContent = checkins.filter(c => c.status === 'waiting').length;
            document.getElementById('activeCount').textContent = checkins.filter(c => c.status === 'active').length;
            document.getElementById('completedCount').textContent = checkins.filter(c => c.status === 'completed').length;
            document.getElementById('avgWaitTime').textContent = 0;
        }
        
        // Auto-cleanup old checkins when starting new day
        function cleanupOldCheckins() {
            const today = new Date().toISOString().split('T')[0];
            const lastCleanupDate = localStorage.getItem('lastCleanupDate');
            
            // Only run cleanup if it's a new day
            if (lastCleanupDate !== today) {
                console.log('🧹 Running daily cleanup...');
                
                const checkins = JSON.parse(localStorage.getItem('allCheckins') || '[]');
                const todayCheckins = checkins.filter(c => c.dateIn === today);
                
                // Keep only today's checkins
                localStorage.setItem('allCheckins', JSON.stringify(todayCheckins));
                localStorage.setItem('lastCleanupDate', today);
                
                // Clear old processing flags
                localStorage.removeItem('lastArchiveDate');
                localStorage.removeItem('endOfDayProcessed');
                
                console.log('🧹 Cleanup complete - removed old checkins, kept', todayCheckins.length, 'for today');
            }
        }
        
        // Update processCheckins to handle status filter
        const originalProcessCheckins = processCheckins;
        processCheckins = function(checkins) {
            const filterValue = document.getElementById('statusFilter') ? document.getElementById('statusFilter').value : 'checked-in';
            const today = new Date().toISOString().split('T')[0];
            let filteredCheckins = checkins.filter(c => c.dateIn === today);
            
            // Apply status filter
            switch(filterValue) {
                case 'checked-in':
                    // Show only waiting patients (checked in but not yet being seen)
                    filteredCheckins = filteredCheckins.filter(c => c.status === 'waiting');
                    break;
                case 'in-treatment':
                    // Show only patients currently being seen
                    filteredCheckins = filteredCheckins.filter(c => c.status === 'active');
                    break;
                case 'was-seen':
                    // Show only completed patients
                    filteredCheckins = filteredCheckins.filter(c => c.status === 'completed');
                    break;
                case 'all-today':
                    // Show all today's patients for printing
                    // Keep all patients - no additional filtering
                    break;
            }
            
            // Continue with original processing but with filtered data
            const tbody = document.getElementById('checkinsTableBody');
            tbody.innerHTML = '';
            
            if (filteredCheckins.length === 0) {
                const row = document.createElement('tr');
                let message = 'No patients found';
                switch(filterValue) {
                    case 'checked-in':
                        message = 'No patients waiting to be seen';
                        break;
                    case 'in-treatment':
                        message = 'No patients currently in treatment';
                        break;
                    case 'was-seen':
                        message = 'No completed patients today';
                        break;
                    case 'all-today':
                        message = 'No patients checked in today';
                        break;
                }
                row.innerHTML = `
                    <td colspan="11" style="text-align: center; padding: 40px; color: #9ca3af; font-style: italic;">
                        ${message}
                    </td>
                `;
                tbody.appendChild(row);
            }
            
            // Stats
            let waitingCount = 0;
            let activeCount = 0;
            let completedCount = 0;
            let totalWaitTime = 0;
            let waitingPatients = 0;
            
            filteredCheckins.forEach(checkin => {
                const waitTime = checkin.status === 'waiting' ? calculateWaitTime(checkin.timeIn) : 
                                checkin.ackTime ? calculateWaitTime(checkin.timeIn) : 0;
                
                if (checkin.status === 'waiting') {
                    waitingCount++;
                    totalWaitTime += waitTime;
                    waitingPatients++;
                } else if (checkin.status === 'active') {
                    activeCount++;
                } else if (checkin.status === 'completed') {
                    completedCount++;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'name', this)"><strong>${checkin.name}</strong></td>
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'phone', this)">${checkin.phone}</td>
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'timeIn', this)">${checkin.timeIn}</td>
                    <td class="editable-cell ${checkin.firstVisit === 'YES' ? 'first-visit-yes' : 'first-visit-no'}" onclick="editField('${checkin.id}', 'firstVisit', this)">${checkin.firstVisit}</td>
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'reason', this)">${checkin.reason}</td>
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'subReason', this)">${checkin.subReason || '-'}</td>
                    <td class="wait-time">${checkin.status === 'waiting' ? formatWaitTime(waitTime) : '-'}</td>
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'status', this)"><span class="status-badge status-${checkin.status}">${checkin.status}</span></td>
                    <td>${checkin.ackBy || '-'}</td>
                    <td class="editable-cell" onclick="editField('${checkin.id}', 'comment', this)">${checkin.comment || ''}</td>
                    <td>
                        <div class="action-btns">
                            ${checkin.status === 'waiting' ? 
                                `<button class="action-btn btn-checkin" onclick="acknowledgePatient('${checkin.id}')">Check In</button>` :
                                checkin.status === 'active' ?
                                `<button class="action-btn btn-checkout" onclick="checkoutPatient('${checkin.id}')">Check Out</button>` :
                                ''
                            }
                            <button class="action-btn btn-comment" onclick="openCommentModal('${checkin.id}')">Comment</button>
                            <button class="action-btn" onclick="deletePatient('${checkin.id}')" style="background: #ef4444; color: white;">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update stats based on ALL today's patients (not just filtered)
            const allTodayCheckins = checkins.filter(c => c.dateIn === today);
            document.getElementById('waitingCount').textContent = allTodayCheckins.filter(c => c.status === 'waiting').length;
            document.getElementById('activeCount').textContent = allTodayCheckins.filter(c => c.status === 'active').length;
            document.getElementById('completedCount').textContent = allTodayCheckins.filter(c => c.status === 'completed').length;
            
            const allWaitingPatients = allTodayCheckins.filter(c => c.status === 'waiting');
            let totalWait = 0;
            allWaitingPatients.forEach(p => {
                totalWait += calculateWaitTime(p.timeIn);
            });
            document.getElementById('avgWaitTime').textContent = allWaitingPatients.length > 0 ? 
                Math.round(totalWait / allWaitingPatients.length) : 0;
            
            // Show refresh complete
            const refreshStatus = document.getElementById('refreshStatus');
            if (refreshStatus) {
                refreshStatus.style.color = '#22c55e';
                refreshStatus.textContent = '●';
            }
            
            console.log('Refresh complete - displayed', filteredCheckins.length, 'check-ins');
        };

        // Initialize
        updateTime();
        setInterval(updateTime, 60000); // Update time every minute
        
        // Import any individual checkins first, then load
        importIndividualCheckins();
        loadCheckins();
        
        setInterval(() => {
            importIndividualCheckins();
            loadCheckins();
        }, 15000); // Auto-refresh every 15 seconds
        setInterval(checkForNewCheckins, 2000); // Check for new checkins every 2 seconds
    </script>
</body>
</html>