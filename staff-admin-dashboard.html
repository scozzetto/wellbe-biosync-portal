<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Admin Dashboard - Be Well LifeStyle Centers</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .admin-header h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .admin-section {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid rgba(164, 124, 91, 0.2);
            margin-bottom: 25px;
            padding: 25px;
        }
        
        .admin-section h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .staff-card {
            background: rgba(164, 124, 91, 0.1);
            border: 1px solid rgba(164, 124, 91, 0.3);
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }
        
        .staff-card h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .staff-info {
            margin-bottom: 15px;
        }
        
        .staff-info p {
            margin: 5px 0;
            color: var(--text-color);
        }
        
        .access-level {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .access-admin {
            background: #e74c3c;
            color: white;
        }
        
        .access-manager {
            background: #f39c12;
            color: white;
        }
        
        .access-staff {
            background: #27ae60;
            color: white;
        }
        
        .access-cafe {
            background: #3498db;
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: transform 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-edit {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .btn-reset {
            background: #f39c12;
            color: white;
        }
        
        .add-staff-form {
            background: rgba(62, 91, 61, 0.1);
            border: 2px solid #3E5B3D;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            color: var(--text-color);
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select {
            padding: 10px;
            border: 1px solid rgba(164, 124, 91, 0.3);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }
        
        .btn-add {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--danger-color);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 15px;
            right: 20px;
        }
        
        .close:hover {
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div style="position: fixed; top: 20px; right: 20px; display: flex; gap: 10px;">
            <button class="logout-btn" onclick="window.location.href='index.html'" style="background: var(--primary-color);">
                <i class="fas fa-home"></i> Home
            </button>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
        
        <div class="admin-header">
            <h1><i class="fas fa-users-cog"></i> Staff Administration Dashboard</h1>
            <p style="color: #9ca3af; font-size: 1.1rem;">Manage staff accounts, permissions, and access levels</p>
            <p id="connection-status" style="color: #6b7280; font-size: 0.9rem; margin-top: 10px;">🔄 Checking connection...</p>
        </div>
        
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-staff">0</div>
                <div>Total Staff</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="active-staff">0</div>
                <div>Active Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="admin-count">0</div>
                <div>Administrators</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cafe-staff">0</div>
                <div>Café Staff</div>
            </div>
        </div>
        
        <!-- Add New Staff -->
        <div class="admin-section">
            <h3><i class="fas fa-user-plus"></i> Add New Staff Member</h3>
            <div class="add-staff-form">
                <form id="add-staff-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="staff-name">Full Name:</label>
                            <input type="text" id="staff-name" required>
                        </div>
                        <div class="form-group">
                            <label for="staff-email">Email:</label>
                            <input type="email" id="staff-email" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="staff-position">Position:</label>
                            <input type="text" id="staff-position" required>
                        </div>
                        <div class="form-group">
                            <label for="staff-location">Location:</label>
                            <select id="staff-location" required>
                                <option value="">Select Location</option>
                                <option value="Birmingham">Birmingham</option>
                                <option value="UWM">UWM</option>
                                <option value="Berkeley">Berkeley</option>
                                <option value="All">All Locations</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="access-level">Access Level:</label>
                            <select id="access-level" required>
                                <option value="">Select Access Level</option>
                                <option value="admin">Administrator</option>
                                <option value="manager">Manager</option>
                                <option value="staff">Staff</option>
                                <option value="cafe">Café Only</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="staff-password">Initial Password:</label>
                            <input type="text" id="staff-password" placeholder="Auto-generated if empty">
                        </div>
                    </div>
                    <button type="submit" class="btn-add">
                        <i class="fas fa-user-plus"></i> Add Staff Member
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Current Staff -->
        <div class="admin-section">
            <h3><i class="fas fa-users"></i> Current Staff Members</h3>
            <div class="staff-grid" id="staff-grid">
                <!-- Staff cards will be dynamically populated -->
            </div>
        </div>
    </div>
    
    <!-- Edit Staff Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 style="color: var(--primary-color); margin-bottom: 20px;">Edit Staff Member</h3>
            <form id="edit-staff-form">
                <input type="hidden" id="edit-staff-id">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="edit-name">Full Name:</label>
                    <input type="text" id="edit-name" required>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="edit-email">Email:</label>
                    <input type="email" id="edit-email" required>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="edit-position">Position:</label>
                    <input type="text" id="edit-position" required>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="edit-location">Location:</label>
                    <select id="edit-location" required>
                        <option value="Birmingham">Birmingham</option>
                        <option value="UWM">UWM</option>
                        <option value="Berkeley">Berkeley</option>
                        <option value="All">All Locations</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="edit-access">Access Level:</label>
                    <select id="edit-access" required>
                        <option value="admin">Administrator</option>
                        <option value="manager">Manager</option>
                        <option value="staff">Staff</option>
                        <option value="cafe">Café Only</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="edit-password">New Password (leave empty to keep current):</label>
                    <input type="text" id="edit-password">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                    <button type="submit" style="background: var(--primary-color); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Authentication Section (same as staff portal) -->
    <div id="auth-section" class="auth-container" style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: var(--bg-color);">
        <button style="position: fixed; top: 20px; right: 20px; background: var(--primary-color); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;" onclick="window.location.href='index.html'">
            <i class="fas fa-home"></i> Home
        </button>
        <div style="background: var(--card-bg); padding: 40px; border-radius: 12px; border: 1px solid rgba(164, 124, 91, 0.3); max-width: 400px; width: 100%; text-align: center;">
            <img src="logo.svg" alt="Be Well Logo" style="height: 50px; width: auto; margin-bottom: 20px; filter: brightness(0) invert(1);">
            <h2 style="color: var(--primary-color); margin-bottom: 20px;">Staff Admin Dashboard</h2>
            <p style="color: #9ca3af; margin-bottom: 25px;">Enter staff password to access admin functions</p>
            
            <form id="auth-form">
                <div style="margin-bottom: 20px; text-align: left;">
                    <label for="password" style="color: var(--text-color); display: block; margin-bottom: 5px; font-weight: 600;">Password:</label>
                    <input type="password" id="password" required style="width: 100%; padding: 12px; border: 1px solid rgba(164, 124, 91, 0.3); border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: var(--text-color); font-size: 1rem;">
                </div>
                <button type="submit" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 12px 30px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%;">Access Admin Dashboard</button>
            </form>
            
            <div id="auth-error" style="color: #ff6b6b; margin-top: 15px; display: none;">
                Incorrect password. Please try again.
            </div>
        </div>
    </div>

    <script>
        // Use same authentication system as staff portal
        let staffData = JSON.parse(localStorage.getItem('staffData')) || [];
        let currentUser = null;
        
        // Initialize with default staff if empty
        if (staffData.length === 0) {
            staffData = [
                {
                    id: 'admin-001',
                    name: 'System Administrator',
                    email: 'admin@bewelllifestylecenters.com',
                    position: 'Administrator',
                    location: 'All',
                    accessLevel: 'admin',
                    password: '$Be7926570!ADMIN',
                    active: true
                },
                {
                    id: 'staff-001',
                    name: 'General Staff',
                    email: 'staff@bewelllifestylecenters.com',
                    position: 'Staff Member',
                    location: 'All',
                    accessLevel: 'staff',
                    password: '$Be7926570!',
                    active: true
                }
            ];
            localStorage.setItem('staffData', JSON.stringify(staffData));
        }
        
        // Simplified authentication for admin dashboard
        function setupAuthentication() {
            const authForm = document.getElementById('auth-form');
            if (!authForm) {
                setTimeout(setupAuthentication, 100);
                return;
            }
            
            authForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const password = document.getElementById('password').value.trim();
                const errorDiv = document.getElementById('auth-error');
                
                // Clear any previous errors
                errorDiv.style.display = 'none';
                
                // Direct password check for admin access
                if (password === '$Be7926570!ADMIN') {
                    // Success - set up admin user
                    const adminUser = {
                        id: 'admin-001',
                        name: 'System Administrator',
                        email: 'admin@bewelllifestylecenters.com',
                        position: 'Administrator',
                        location: 'All',
                        accessLevel: 'admin',
                        active: true
                    };
                    
                    currentUser = adminUser;
                    sessionStorage.setItem('staffAuthenticated', 'true');
                    sessionStorage.setItem('currentUser', JSON.stringify(adminUser));
                    sessionStorage.setItem('adminAuthenticated', 'true');
                    
                    // Hide auth section, show admin dashboard
                    document.getElementById('auth-section').style.display = 'none';
                    document.querySelector('.admin-container').style.display = 'block';
                    
                    // Load staff data
                    loadStaffData();
                    
                } else if (password === '$Be7926570!') {
                    // Regular staff tried to access admin
                    errorDiv.style.display = 'block';
                    errorDiv.innerHTML = '❌ Admin access required. This password is for regular staff only.';
                    document.getElementById('password').value = '';
                    
                } else {
                    // Wrong password
                    errorDiv.style.display = 'block';
                    errorDiv.innerHTML = '❌ Invalid password. Use: <strong>$Be7926570!ADMIN</strong>';
                    document.getElementById('password').value = '';
                }
            });
        }
        
        // Start authentication setup immediately
        setupAuthentication();
        
        // Setup add staff form
        setupAddStaffForm();
        
        // Setup initial display state
        function setupInitialDisplay() {
            const adminContainer = document.querySelector('.admin-container');
            const authSection = document.getElementById('auth-section');
            
            if (!adminContainer || !authSection) {
                setTimeout(setupInitialDisplay, 100);
                return;
            }
            
            // Hide admin container initially
            adminContainer.style.display = 'none';
            authSection.style.display = 'flex';
            
            // Check if already authenticated
            if (sessionStorage.getItem('adminAuthenticated') && sessionStorage.getItem('currentUser')) {
                const user = JSON.parse(sessionStorage.getItem('currentUser'));
                if (user.accessLevel === 'admin') {
                    authSection.style.display = 'none';
                    adminContainer.style.display = 'block';
                    currentUser = user;
                    loadStaffData();
                }
            }
        }
        
        setupInitialDisplay();
        
        // Staff management system
        let staffData = [];
        
        // Load staff data from Dropbox (with Netlify fallback)
        async function loadStaffData() {
            try {
                // Try Dropbox first
                const response = await fetch('/.netlify/functions/dropbox-manager');
                const result = await response.json();
                
                if (response.ok && !result.setup_required) {
                    staffData = result;
                    renderStaffGrid();
                    updateStats();
                    document.getElementById('connection-status').innerHTML = '✅ Connected to Dropbox';
                    return;
                }
                
                if (result.setup_required) {
                    document.getElementById('connection-status').innerHTML = '⚠️ Dropbox setup required - using local storage';
                    showDropboxSetupInstructions();
                }
                
                // Fallback to original staff-manager
                const fallbackResponse = await fetch('/.netlify/functions/staff-manager');
                if (fallbackResponse.ok) {
                    staffData = await fallbackResponse.json();
                    renderStaffGrid();
                    updateStats();
                    document.getElementById('connection-status').innerHTML = '🔄 Using Netlify backup (Dropbox unavailable)';
                    return;
                }
                
                // Final fallback to localStorage
                staffData = JSON.parse(localStorage.getItem('staffData')) || [];
                if (staffData.length === 0) {
                    staffData = [
                        {
                            id: 'admin-001',
                            name: 'System Administrator',
                            email: 'admin@bewelllifestylecenters.com',
                            position: 'Administrator',
                            location: 'All',
                            accessLevel: 'admin',
                            password: '$Be7926570!ADMIN',
                            active: true,
                            created: new Date().toISOString()
                        }
                    ];
                    localStorage.setItem('staffData', JSON.stringify(staffData));
                }
                renderStaffGrid();
                updateStats();
                document.getElementById('connection-status').innerHTML = '⚠️ Using local storage only';
                
            } catch (error) {
                console.error('Error loading staff data:', error);
                document.getElementById('connection-status').innerHTML = '❌ Connection error - using local storage';
                
                // Emergency fallback
                staffData = JSON.parse(localStorage.getItem('staffData')) || [];
                renderStaffGrid();
                updateStats();
            }
        }
        
        // Show Dropbox setup instructions
        function showDropboxSetupInstructions() {
            const instructionsDiv = document.createElement('div');
            instructionsDiv.id = 'dropbox-setup';
            instructionsDiv.style.cssText = 'background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 20px; margin: 20px 0; color: #92400e;';
            instructionsDiv.innerHTML = `
                <h3 style="color: #92400e; margin-top: 0;">🔧 Dropbox Setup Required</h3>
                <p><strong>To enable Dropbox sync, you need to:</strong></p>
                <ol>
                    <li>Create a Dropbox app at <a href="https://www.dropbox.com/developers/apps" target="_blank">https://www.dropbox.com/developers/apps</a></li>
                    <li>Get your access token</li>
                    <li>Add it to Netlify environment variables as <code>DROPBOX_ACCESS_TOKEN</code></li>
                </ol>
                <button onclick="hideDropboxInstructions()" style="background: #f59e0b; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">I'll set this up later</button>
            `;
            
            const header = document.querySelector('.admin-header');
            header.after(instructionsDiv);
        }
        
        function hideDropboxInstructions() {
            const instructions = document.getElementById('dropbox-setup');
            if (instructions) instructions.remove();
        }
        
        // Generate random password
        function generatePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }
        
        // Add new staff member (with Dropbox sync)
        function setupAddStaffForm() {
            const form = document.getElementById('add-staff-form');
            if (!form) {
                setTimeout(setupAddStaffForm, 100);
                return;
            }
            
            form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('staff-name').value;
            const email = document.getElementById('staff-email').value;
            const position = document.getElementById('staff-position').value;
            const location = document.getElementById('staff-location').value;
            const accessLevel = document.getElementById('access-level').value;
            let password = document.getElementById('staff-password').value;
            
            if (!password) {
                password = generatePassword();
            }
            
            try {
                // Try Dropbox first
                const response = await fetch('/.netlify/functions/dropbox-manager', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'add-staff',
                        name,
                        email,
                        position,
                        location,
                        accessLevel,
                        password
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`✅ Staff member added successfully and synced to Dropbox!\n\nName: ${name}\nEmail: ${email}\nPassword: ${password}\n\nMake sure to share the password securely with the staff member.`);
                    document.getElementById('add-staff-form').reset();
                    loadStaffData(); // Reload from Dropbox
                    return;
                }
            } catch (error) {
                console.error('Dropbox add failed:', error);
            }
            
            // Fallback to local storage
            const newStaff = {
                id: 'staff-' + Date.now(),
                name,
                email,
                position,
                location,
                accessLevel,
                password,
                active: true,
                created: new Date().toISOString()
            };
            
            staffData.push(newStaff);
            localStorage.setItem('staffData', JSON.stringify(staffData));
            
            alert(`⚠️ Staff member added locally (Dropbox unavailable)\n\nName: ${name}\nEmail: ${email}\nPassword: ${password}\n\nNote: This won't sync across devices until Dropbox is configured.`);
            
            document.getElementById('add-staff-form').reset();
            renderStaffGrid();
            updateStats();
            });
        }
        
        // Render staff grid
        function renderStaffGrid() {
            const grid = document.getElementById('staff-grid');
            grid.innerHTML = '';
            
            staffData.forEach(staff => {
                const card = document.createElement('div');
                card.className = 'staff-card';
                card.innerHTML = `
                    <h4>${staff.name}</h4>
                    <div class="staff-info">
                        <p><strong>Email:</strong> ${staff.email}</p>
                        <p><strong>Position:</strong> ${staff.position}</p>
                        <p><strong>Location:</strong> ${staff.location}</p>
                        <p><strong>Password:</strong> <code style="background: rgba(0,0,0,0.2); padding: 2px 4px; border-radius: 3px;">${staff.password}</code></p>
                        <p><strong>Access:</strong> <span class="access-level access-${staff.accessLevel}">${staff.accessLevel}</span></p>
                        <p><strong>Status:</strong> ${staff.active ? '✅ Active' : '❌ Inactive'}</p>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-edit" onclick="editStaff('${staff.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-reset" onclick="resetPassword('${staff.id}')">
                            <i class="fas fa-key"></i> Reset Password
                        </button>
                        <button class="btn btn-delete" onclick="deleteStaff('${staff.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        // Update statistics
        function updateStats() {
            document.getElementById('total-staff').textContent = staffData.length;
            document.getElementById('active-staff').textContent = staffData.filter(s => s.active).length;
            document.getElementById('admin-count').textContent = staffData.filter(s => s.accessLevel === 'admin').length;
            document.getElementById('cafe-staff').textContent = staffData.filter(s => s.accessLevel === 'cafe').length;
        }
        
        // Edit staff member
        function editStaff(id) {
            const staff = staffData.find(s => s.id === id);
            if (!staff) return;
            
            document.getElementById('edit-staff-id').value = staff.id;
            document.getElementById('edit-name').value = staff.name;
            document.getElementById('edit-email').value = staff.email;
            document.getElementById('edit-position').value = staff.position;
            document.getElementById('edit-location').value = staff.location;
            document.getElementById('edit-access').value = staff.accessLevel;
            document.getElementById('edit-password').value = '';
            
            document.getElementById('edit-modal').style.display = 'block';
        }
        
        // Save staff edits
        document.getElementById('edit-staff-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('edit-staff-id').value;
            const staffIndex = staffData.findIndex(s => s.id === id);
            
            if (staffIndex === -1) return;
            
            staffData[staffIndex].name = document.getElementById('edit-name').value;
            staffData[staffIndex].email = document.getElementById('edit-email').value;
            staffData[staffIndex].position = document.getElementById('edit-position').value;
            staffData[staffIndex].location = document.getElementById('edit-location').value;
            staffData[staffIndex].accessLevel = document.getElementById('edit-access').value;
            
            const newPassword = document.getElementById('edit-password').value;
            if (newPassword) {
                staffData[staffIndex].password = newPassword;
            }
            
            localStorage.setItem('staffData', JSON.stringify(staffData));
            closeModal();
            renderStaffGrid();
            updateStats();
            
            alert('Staff member updated successfully!');
        });
        
        // Reset password
        function resetPassword(id) {
            const staff = staffData.find(s => s.id === id);
            if (!staff) return;
            
            const newPassword = generatePassword();
            staff.password = newPassword;
            
            localStorage.setItem('staffData', JSON.stringify(staffData));
            renderStaffGrid();
            
            alert(`Password reset for ${staff.name}\nNew Password: ${newPassword}\n\nMake sure to share the new password securely.`);
        }
        
        // Delete staff member
        function deleteStaff(id) {
            const staff = staffData.find(s => s.id === id);
            if (!staff) return;
            
            if (confirm(`Are you sure you want to delete ${staff.name}? This action cannot be undone.`)) {
                staffData = staffData.filter(s => s.id !== id);
                localStorage.setItem('staffData', JSON.stringify(staffData));
                renderStaffGrid();
                updateStats();
            }
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }
        
        // Logout
        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            window.location.href = 'index.html';
        }
        
        // Initialize - authentication is now handled by setupAuthentication()
        // The page will show the login form initially, then show admin dashboard after login
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <!-- Auto-backup system -->
    <script src="auto-backup.js"></script>
</body>
</html>